---
title: "project code"
author: "Rob McNeil and Jessica Chaffee"
date: "2024-11-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




Load library, import data set, spit training and testing data

```{r}
library(caret)
library(randomForest)
library(ggplot2)
library(ggcorrplot)


#linux pathway
adpkd <- read.csv("/home/robmcneil/Documents/advanced_data/Project3_data.csv")

str(adpkd)

# code to do a 70/30, most likely will go with K fold
#set.seed(123)
#randomly split data into 70/30 
#sample <- sample(c(TRUE, FALSE), nrow(adpkd), replace=TRUE,prob=c(0.7,0.3))
#training <-adpkd[sample, ]
#testing <- adpkd[!sample,]

#using k-fold 5 validation 

ctrl <-trainControl(method = "cv",
                    number = 5,
                    savePredictions = "final",
                    summaryFunction = defaultSummary 
)
    



```


Data scaling/normalization
Outlier detection with visualization

data visualization? 
correlation matrix? 
```{r}

#check distribution of progression

table(adpkd$progression)
#binary outcome is evenly distributed 


sum(is.na(adpkd$progression))
#no missing outcomes

#convert progression to factor
adpkd$progression <-factor(adpkd$progression,levels = c(0,1))



```

Data visualization

```{r}

#data visualizations reccomendatios from AI
corr_matrix <- cor(adpkd[, c("tkvht_base", "geom1","geom2", "gabor1", "gabor2","gabor3","gabor4","gabor5","glcm1","glcm2","txti1","txti2","txti3","txti4","txti5","lbp1","lbp2","lbp3","lbp4","lbp5" )], use = "complete.obs")
ggplot2::ggcorrplot(corr_matrix, method = "circle")


#outlierdetection  or scatter plot
#appears as though outliers in low base and high baseline measurement are causing issues with homoscadascity 
ggplot(adpkd, aes(x = tkvht_base, y=tkvht_change)) + 
  geom_point()



#feature visualization
ggplot(adpkd, aes(x = tkvht_base, y = tkvht_change, color = progression)) + 
  geom_point() + 
  geom_smooth(method = "lm")
```



Models for percent changes predictions 
```{r}

#model using height-corrected total kidney volume
model_tkv <- train(
  tkvht_change ~ tkvht_base,    # Formula for the model
  data = adpkd,               
  method = "lm",               # Linear model (lm)
  trControl = ctrl,            # Cross-validation control
  preProcess = c("center", "scale")  # Preprocessing: center and scale the data
)

summary(model_tkv)

# Model 2: Using only image features
#look at feature engineering
model_image <- train(
  tkvht_change ~ geom1 + geom2 + #image feature based on kidney geometry information
    gabor1 + gabor2 + gabor3 + gabor4 + gabor5 + 
    glcm1 + glcm2 + #image feature based on gray level co-occurrence matrix
    txti1 + txti2 + txti3 + txti4 + txti5 + #image feature based on image textures
    lbp1 + lbp2 + lbp3 + lbp4 + lbp5, # local binary pattern
  data =  adpkd,
  method = "lm",
  trControl=ctrl, #cross validation control 
  preProcess = c("center","scale")) #preprossing 


#extract residuals

model_image_fitted<- predict(model_image)
model_image_resid <-  resid(model_image)

#plot residuals
ggplot(data= NULL, aes(x=model_image_fitted,y=model_image_resid)) +
  geom_point()+
  geom_hline(yintercept = 0, linetype="dashed", color = "red")+
  labs(title = "figure: model imaging lm residuals vs fitted",
       x = "fitted values",
       y= "residual values")+
  theme_minimal()

#qqplot to check normality 
qqnorm(model_image_resid, main = "Q-Q Plot of Residuals for model imaging lm")
qqline(model_image_resid, col= "red")





# Print the results
print(model_image)

# attempted to Check performance comparison across models
#model_image$results

#model 3 (baseline tkvht and image featuring): 

model_both <- train(
  tkvht_change ~ tkvht_base +
    gabor1 + gabor2 + gabor3 + gabor4 + gabor5 + 
    glcm1 + glcm2 + #image feature based on gray level co-occurrence matrix
    txti1 + txti2 + txti3 + txti4 + txti5 + #image feature based on image textures
    lbp1 + lbp2 + lbp3 + lbp4 + lbp5, # local binary pattern 
  data = adpkd,
  method= "lm",
  trControl = ctrl, #cross validation control
  preProcess= c("center", "scale")
    )




```

model seletion/ comparion of tvk prediction

```{r}
#initial code from AI reccomendation, using resamples

# Compare models on RSME, R-squared
resamples_list <- resamples(list(model_tkv=model_tkv, model_image=model_image))
summary(resamples_list)




```



Models for prediction of progressoin (binary). Getting warnings of perfect seperation

```{r}

#model using height-corrected total kidney volume
model_tkv_pro <- train(
  progression~ tkvht_base,    # Formula for the model
  data = adpkd,               
  method = "glm", 
  family = "binomial",# Linear model (lm)
  trControl = ctrl,            # Cross-validation control
  preProcess = c("center", "scale")  # Preprocessing: center and scale the data
)

summary(model_tkv_pro)

# Model 2: Using only image features
#look at feature engineering
model_image_pro <- train(
  progression~ geom1 + geom2 + #image feature based on kidney geometry information
    gabor1 + gabor2 + gabor3 + gabor4 + gabor5 + 
    glcm1 + glcm2 + #image feature based on gray level co-occurrence matrix
    txti1 + txti2 + txti3 + txti4 + txti5 + #image feature based on image textures
    lbp1 + lbp2 + lbp3 + lbp4 + lbp5, # local binary pattern
  data =  adpkd,
  method = "glm",
  family = "binomial",
  trControl=ctrl, #cross validation control 
  preProcess = c("center","scale")) #preprossing 


# Print the results
print(model_image_pro)

# attempted to Check performance comparison across models
#model_image$results

#model 3 (baseline tkvht and image featuring): 

model_both_pro <- train(
  progression ~ tkvht_base +
    gabor1 + gabor2 + gabor3 + gabor4 + gabor5 + 
    glcm1 + glcm2 + #image feature based on gray level co-occurrence matrix
    txti1 + txti2 + txti3 + txti4 + txti5 + #image feature based on image textures
    lbp1 + lbp2 + lbp3 + lbp4 + lbp5, # local binary pattern 
  data = adpkd,
  method= "glm",
  family = "binomial",
  trControl = ctrl, #cross validation control
  preProcess= c("center", "scale")
    )




```






